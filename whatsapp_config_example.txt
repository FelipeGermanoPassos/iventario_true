# Configura√ß√£o do WhatsApp Business API

Este arquivo cont√©m exemplos de configura√ß√£o para integra√ß√£o com WhatsApp Business API.

## üì± Provedores Suportados

O sistema suporta tr√™s provedores principais:
1. **Twilio** (Recomendado para Brasil)
2. **MessageBird**
3. **Meta (Facebook) WhatsApp Business API**

## üîß Configura√ß√£o por Provedor

### 1. Twilio WhatsApp API

**Vantagens:**
- F√°cil configura√ß√£o
- Suporte em portugu√™s
- Sandbox gratuito para testes
- Pre√ßos competitivos no Brasil

**Como configurar:**

1. Crie uma conta em: https://www.twilio.com/try-twilio
2. Acesse o Console ‚Üí Messaging ‚Üí Try it out ‚Üí Send a WhatsApp message
3. Configure o WhatsApp Sandbox seguindo as instru√ß√µes
4. Obtenha suas credenciais:
   - Account SID
   - Auth Token
   - WhatsApp From Number (ex: +14155238886)

**Vari√°veis de ambiente:**

```bash
# Windows PowerShell
$env:WHATSAPP_ENABLED="true"
$env:WHATSAPP_PROVIDER="twilio"
$env:TWILIO_ACCOUNT_SID="seu-account-sid-aqui"
$env:TWILIO_AUTH_TOKEN="seu-auth-token-aqui"
$env:TWILIO_WHATSAPP_FROM="+14155238886"

# Linux/Mac
export WHATSAPP_ENABLED=true
export WHATSAPP_PROVIDER=twilio
export TWILIO_ACCOUNT_SID=seu-account-sid-aqui
export TWILIO_AUTH_TOKEN=seu-auth-token-aqui
export TWILIO_WHATSAPP_FROM=+14155238886
```

**Pre√ßos (aproximados):**
- Conversa√ß√µes iniciadas pelo neg√≥cio: $0.005 - $0.068 por mensagem
- Conversa√ß√µes iniciadas pelo usu√°rio: gratuitas nas primeiras 24h

---

### 2. MessageBird

**Vantagens:**
- Cobertura global
- API robusta
- Documenta√ß√£o excelente

**Como configurar:**

1. Crie uma conta em: https://messagebird.com
2. Acesse Dashboard ‚Üí Channels ‚Üí WhatsApp
3. Configure um canal WhatsApp
4. Obtenha:
   - API Key
   - Channel ID

**Vari√°veis de ambiente:**

```bash
# Windows PowerShell
$env:WHATSAPP_ENABLED="true"
$env:WHATSAPP_PROVIDER="messagebird"
$env:MESSAGEBIRD_API_KEY="sua-api-key-aqui"
$env:MESSAGEBIRD_CHANNEL_ID="seu-channel-id-aqui"

# Linux/Mac
export WHATSAPP_ENABLED=true
export WHATSAPP_PROVIDER=messagebird
export MESSAGEBIRD_API_KEY=sua-api-key-aqui
export MESSAGEBIRD_CHANNEL_ID=seu-channel-id-aqui
```

---

### 3. Meta (Facebook) WhatsApp Business API

**Vantagens:**
- API oficial do WhatsApp
- Sem intermedi√°rios
- Mensagens gratuitas (at√© certo volume)

**Como configurar:**

1. Crie conta no Meta Business: https://business.facebook.com
2. Acesse Meta for Developers: https://developers.facebook.com
3. Crie um app de tipo "Business"
4. Adicione o produto "WhatsApp"
5. Configure o n√∫mero de telefone
6. Obtenha:
   - Access Token
   - Phone Number ID

**Vari√°veis de ambiente:**

```bash
# Windows PowerShell
$env:WHATSAPP_ENABLED="true"
$env:WHATSAPP_PROVIDER="meta"
$env:META_WHATSAPP_TOKEN="seu-access-token-aqui"
$env:META_WHATSAPP_PHONE_ID="seu-phone-number-id-aqui"

# Linux/Mac
export WHATSAPP_ENABLED=true
export WHATSAPP_PROVIDER=meta
export META_WHATSAPP_TOKEN=seu-access-token-aqui
export META_WHATSAPP_PHONE_ID=seu-phone-number-id-aqui
```

**Pre√ßos:**
- Primeiras 1.000 conversas/m√™s: GRATUITAS
- Ap√≥s isso: a partir de $0.005 por conversa

---

## üìù Arquivo .env (Recomendado)

Crie ou edite o arquivo `.env` na raiz do projeto:

```env
# ===== WHATSAPP CONFIGURATION =====

# Habilitar/Desabilitar WhatsApp
WHATSAPP_ENABLED=true

# Provedor: twilio, messagebird ou meta
WHATSAPP_PROVIDER=twilio

# ===== TWILIO =====
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_WHATSAPP_FROM=+14155238886

# ===== MESSAGEBIRD =====
# MESSAGEBIRD_API_KEY=seu-api-key-aqui
# MESSAGEBIRD_CHANNEL_ID=seu-channel-id-aqui

# ===== META (FACEBOOK) =====
# META_WHATSAPP_TOKEN=seu-access-token-aqui
# META_WHATSAPP_PHONE_ID=seu-phone-number-id-aqui
```

‚ö†Ô∏è **IMPORTANTE:** Adicione `.env` ao `.gitignore` para n√£o expor suas credenciais!

---

## üß™ Como Testar

### Via c√≥digo Python:

```python
from app.whatsapp_service import WhatsAppService

# Enviar mensagem de teste
result = WhatsAppService.send_test_message('+5511999999999')
print(result)
```

### Via interface web:

1. Acesse o painel admin
2. V√° em "Configura√ß√µes" ‚Üí "WhatsApp"
3. Preencha as credenciais
4. Clique em "Testar Conex√£o"
5. Digite um n√∫mero de telefone
6. Clique em "Enviar Teste"

---

## üìã Formato de N√∫meros de Telefone

O sistema aceita v√°rios formatos e converte automaticamente:

**Entrada aceita:**
- `11999999999` ‚Üí convertido para `+5511999999999`
- `(11) 99999-9999` ‚Üí convertido para `+5511999999999`
- `+55 11 99999-9999` ‚Üí convertido para `+5511999999999`
- `+5511999999999` ‚Üí usado diretamente

**Regras:**
- C√≥digo do pa√≠s (Brasil): +55
- DDD: 2 d√≠gitos
- N√∫mero: 9 d√≠gitos para celular (inicia com 9)

---

## üöÄ Tipos de Notifica√ß√µes Enviadas

O sistema envia automaticamente via WhatsApp:

1. ‚úÖ **Confirma√ß√£o de empr√©stimo** (imediato)
2. ‚úÖ **Confirma√ß√£o de devolu√ß√£o** (imediato)
3. ‚è∞ **Lembrete de devolu√ß√£o** (3 dias antes)
4. üö® **Alerta de atraso** (diariamente ap√≥s vencimento)

---

## üí∞ Comparativo de Custos

| Provedor | Sandbox Gr√°tis | Custo por Mensagem | Melhor Para |
|----------|----------------|-------------------|-------------|
| **Twilio** | ‚úÖ Sim | $0.005 - $0.068 | Brasil, testes |
| **MessageBird** | ‚ö†Ô∏è Limitado | $0.010 - $0.070 | Europa, global |
| **Meta** | ‚úÖ 1000/m√™s | $0.005 (ap√≥s limite) | Alto volume |

---

## üîí Seguran√ßa

- ‚úÖ Credenciais armazenadas em vari√°veis de ambiente
- ‚úÖ N√£o compartilhe tokens/keys publicamente
- ‚úÖ Use `.env` e adicione ao `.gitignore`
- ‚úÖ Tokens com permiss√µes m√≠nimas necess√°rias
- ‚úÖ Rota√ß√£o peri√≥dica de credenciais

---

## üêõ Solu√ß√£o de Problemas

### "WhatsApp desabilitado"
**Solu√ß√£o:** Defina `WHATSAPP_ENABLED=true`

### "Credenciais n√£o configuradas"
**Solu√ß√£o:** Verifique se todas as vari√°veis do provedor escolhido est√£o definidas

### "N√∫mero de telefone inv√°lido"
**Solu√ß√£o:** Use formato internacional com c√≥digo do pa√≠s (+55)

### "Erro 401 Unauthorized"
**Solu√ß√£o:** Verifique se as credenciais est√£o corretas

### "Erro 403 Forbidden"
**Solu√ß√£o:** Verifique se o n√∫mero est√° verificado no sandbox/produ√ß√£o

### "Erro 429 Too Many Requests"
**Solu√ß√£o:** Aguarde alguns minutos, voc√™ atingiu o limite de taxa

---

## üìö Documenta√ß√£o Oficial

- **Twilio:** https://www.twilio.com/docs/whatsapp
- **MessageBird:** https://developers.messagebird.com/api/conversations/
- **Meta:** https://developers.facebook.com/docs/whatsapp

---

## üí° Dicas

1. **Comece com Twilio Sandbox** para testes gratuitos
2. **Use templates aprovados** pelo WhatsApp para mensagens de marketing
3. **Mensagens transacionais** (como nosso sistema) t√™m menos restri√ß√µes
4. **Monitore custos** atrav√©s do dashboard do provedor
5. **Respeite opt-out** de usu√°rios que n√£o querem receber mensagens

---

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Criar conta no provedor escolhido
- [ ] Obter credenciais (API keys, tokens)
- [ ] Configurar vari√°veis de ambiente
- [ ] Adicionar `.env` ao `.gitignore`
- [ ] Testar envio de mensagem
- [ ] Configurar n√∫mero de telefone no perfil dos usu√°rios
- [ ] Verificar recebimento das notifica√ß√µes
- [ ] Monitorar logs de envio
- [ ] Documentar para equipe

---

**üéâ Pronto!** Seu sistema agora pode enviar lembretes via WhatsApp!
